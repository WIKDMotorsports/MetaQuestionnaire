<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WIKD Motorsports | Custom Tuning Configurator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <script src="https://animatedicons.co/scripts/embed-animated-icons.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '796935762872173');
    fbq('track', 'PageView');
    </script>
    <noscript>
      <img height="1" width="1" style="display:none"
        src="https://www.facebook.com/tr?id=796935762872173&ev=PageView&noscript=1"/>
    </noscript>
    <style>
        :root {
            --color-background: #0A0A0A;
            --color-text: #EAEAEA;
            --color-text-muted: #888888;
            --color-primary: #FF3B30;
            --color-primary-dark: #C70039;
            --color-secondary: #007AFF;
            --color-tertiary: #34C759;
            --color-surface: #141414;
            --color-border: #2A2A2A;
            --font-heading: 'Rajdhani', sans-serif;
            --font-body: 'Inter', sans-serif;
            --ease-out-heavy: cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* General Styles */
        html {
            box-sizing: border-box;
            scroll-behavior: smooth;
        }
        *, *:before, *:after {
            box-sizing: inherit;
        }
        body {
            background-color: var(--color-background);
            color: var(--color-text);
            font-family: var(--font-body);
            line-height: 1.6;
            padding: 0;
            margin: 0;
        }

        h1, h2, h3 {
            font-family: var(--font-heading);
            text-transform: uppercase;
            font-weight: 700;
            color: white;
            line-height: 1.2;
        }
        
        .widget-container {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        @keyframes colorFlowPosition {
            0%   { background-position: 0 0, 0% 50%; }
            50%  { background-position: 0 0, 100% 50%; }
            100% { background-position: 0 0, 0% 50%; }
        }

        .panel {
            background-color: var(--color-surface);
            border-radius: 0;
            padding: 2rem;
            margin: 0 0 2rem 0;
            transition: all 0.5s ease;
            position: relative;
            border: 1px solid transparent;
            background-clip: padding-box;
            border-left: none;
            border-right: none;
        }

        .panel::before,
        .panel::after {
            content: '';
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            z-index: -1;
            margin: -1px;
            border-radius: inherit;
            background-size: 100% 100%, 300% 100%;
            animation: colorFlowPosition 4s ease-in-out infinite;
            transition: opacity 0.8s ease-in-out;
            opacity: 0;
        }

        .panel.show-before::before { opacity: 1; }
        .panel.show-after::after { opacity: 1; }
        
        .panel.theme-packages-before::before { background-image: linear-gradient(to bottom, transparent 0px, transparent 35px, var(--color-border) 125px), linear-gradient(90deg, rgba(179,0,0,0.5), rgba(255,26,0,0.6), rgba(255,170,0,0.5), rgba(255,26,0,0.6), rgba(179,0,0,0.5)); }
        .panel.theme-wheels-before::before { background-image: linear-gradient(to bottom, transparent 0px, transparent 35px, var(--color-border) 125px), linear-gradient(90deg, rgba(0,77,0,0.5), rgba(0,128,0,0.6), rgba(144,238,144,0.5), rgba(0,128,0,0.6), rgba(0,77,0,0.5)); }
        .panel.theme-cooling-before::before { background-image: linear-gradient(to bottom, transparent 0px, transparent 35px, var(--color-border) 125px), linear-gradient(90deg, rgba(0,197,255,0.5), rgba(255,255,255,0.6), rgba(175,238,238,0.5), rgba(255,255,255,0.6), rgba(0,197,255,0.5)); }
        .panel.theme-exhaust-before::before { background-image: linear-gradient(to bottom, transparent 0px, transparent 35px, var(--color-border) 125px), linear-gradient(90deg, rgba(75,0,130,0.5), rgba(128,0,0,0.6), rgba(138,43,226,0.5), rgba(128,0,0,0.6), rgba(75,0,130,0.5)); }
        .panel.theme-packages-after::after { background-image: linear-gradient(to bottom, transparent 0px, transparent 35px, var(--color-border) 125px), linear-gradient(90deg, rgba(179,0,0,0.5), rgba(255,26,0,0.6), rgba(255,170,0,0.5), rgba(255,26,0,0.6), rgba(179,0,0,0.5)); }
        .panel.theme-wheels-after::after { background-image: linear-gradient(to bottom, transparent 0px, transparent 35px, var(--color-border) 125px), linear-gradient(90deg, rgba(0,77,0,0.5), rgba(0,128,0,0.6), rgba(144,238,144,0.5), rgba(0,128,0,0.6), rgba(0,77,0,0.5)); }
        .panel.theme-cooling-after::after { background-image: linear-gradient(to bottom, transparent 0px, transparent 35px, var(--color-border) 125px), linear-gradient(90deg, rgba(0,197,255,0.5), rgba(255,255,255,0.6), rgba(175,238,238,0.5), rgba(255,255,255,0.6), rgba(0,197,255,0.5)); }
        .panel.theme-exhaust-after::after { background-image: linear-gradient(to bottom, transparent 0px, transparent 35px, var(--color-border) 125px), linear-gradient(90deg, rgba(75,0,130,0.5), rgba(128,0,0,0.6), rgba(138,43,226,0.5), rgba(128,0,0,0.6), rgba(75,0,130,0.5)); }
        
        .form-step { display: none; }
        .form-step.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .step-header { text-align: center; margin-bottom: 2rem; }
        .step-header h2 { font-size: 2.5rem; margin: 0 0 0.25rem; }
        .step-header p { color: var(--color-text-muted); font-size: 1rem; margin-top: 0; }
        
        .progress-bar { position: relative; display: flex; justify-content: space-between; margin-bottom: 2rem; max-width: 900px; margin-left: auto; margin-right: auto; padding: 0 1rem; }
        .progress-bar::before { content: ''; position: absolute; top: 4px; left: var(--bar-start-offset, 10%); width: var(--bar-width, 80%); height: 2px; background-color: var(--color-border); }
        .progress-bar::after { content: ''; position: absolute; top: 4px; left: var(--bar-start-offset, 10%); width: var(--progress-width, 0%); height: 2px; background-color: var(--color-primary); transition: width 0.4s ease-in-out; }
        .progress-step { flex: 1; text-align: center; position: relative; font-family: var(--font-heading); font-size: 0.9rem; font-weight: 600; color: var(--color-text-muted); transition: color 0.3s ease; cursor: default; padding-top: 20px; }
        .step-node { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 6px; height: 10px; background-color: var(--color-background); border: 2px solid var(--color-border); border-radius: 2px; transition: all 0.3s ease; z-index: 1; }
        .progress-step.completed { color: var(--color-text); }
        .progress-step.completed .step-node { background-color: var(--color-primary); border-color: var(--color-primary); }
        .progress-step.active { color: var(--color-primary); }
        .progress-step.active .step-node { border-color: var(--color-primary); }

        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: .5rem; font-weight: 600; font-family: var(--font-heading); font-size: 1.2rem; text-transform: uppercase; }
        .vin-input-group { display: flex; gap: 0.5rem; align-items: center; }
        .form-control { width: 100%; padding: 12px; background-color: var(--color-background); border: 1px solid var(--color-border); border-radius: 6px; color: var(--color-text); font-size: 1rem; transition: border-color 0.3s ease; box-sizing: border-box; flex-grow: 1; }
        .form-control:focus { outline: none; border-color: var(--color-primary); }
        .form-control:disabled { background-color: #2a2a2a; color: #888; cursor: not-allowed; }
        .form-control option { background: var(--color-surface); color: var(--color-text); }
        .form-control option.top-highlight { color: var(--color-primary); font-weight: 600 }
        .form-control option.model-highlight { color: var(--color-primary); font-weight: 600 }
        .form-control option.separator { font-weight: 600; background: var(--color-border); color: var(--color-text-muted) }
        
        .choice-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        .choice-input { display: none; }
        .choice-label { display: flex; align-items: center; justify-content: center; padding: 10px 24px; font-family: var(--font-heading); font-size: 1.1rem; font-weight: 600; text-transform: uppercase; color: var(--color-text); background-color: transparent; border: 2px solid var(--color-border); position: relative; overflow: hidden; transition: color 0.4s ease-in-out, background-color 0.4s ease-in-out; cursor: pointer; text-align: center; min-height: 48px; }
        .choice-group > *:first-child .choice-label { clip-path: polygon(0 0, 100% 0, 100% 100%, 10px 100%, 0 85%); }
        .choice-group > *:last-child:not(:first-child) .choice-label { clip-path: polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%); }
        .choice-input:checked + .choice-label { background-color: var(--color-primary); border-color: var(--color-primary); color: white; }

        .btn-group { display: flex; justify-content: space-between; margin-top: 2rem; gap: 1rem; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px 28px; font-family: var(--font-heading); font-size: 1.1rem; font-weight: 600; text-transform: uppercase; color: var(--color-text); background-color: transparent; border: 2px solid var(--color-border); position: relative; overflow: hidden; transition: color 0.4s ease-in-out, background-color 0.4s ease-in-out, border-color 0.4s ease-in-out; cursor: pointer; text-align: center; text-decoration: none; flex-grow: 1; gap: 0.5rem; z-index: 1; }
        .btn.btn-left { clip-path: polygon(0 0, 100% 0, 100% 100%, 10px 100%, 0 85%); }
        .btn.btn-right { clip-path: polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%); }
        .btn span, .choice-label span, .btn i, .btn animated-icons { position: relative; z-index: 2; }
        .btn span { top: 1px; }
        .btn::before { content: ''; position: absolute; top: 0; left: 0; width: 0; height: 100%; background-color: var(--color-primary); transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1); z-index: -1; }
        .btn-primary { border-color: var(--color-primary); color: var(--color-primary); }
        .btn-primary:hover { color: white; border-color: var(--color-primary); }
        .btn-primary:hover::before { width: 100%; }
        .prev-btn:hover { border-color: var(--color-border); color: var(--color-text); background-color: transparent; }
        .btn-primary-filled, .btn.selected { background-color: var(--color-primary); border-color: var(--color-primary); color: white; }
        .btn-primary-filled:hover, .btn.selected:hover { background-color: #e03024; border-color: #e03024; }
        .btn:disabled { border-color: var(--color-border); color: var(--color-text-muted); cursor: not-allowed; background-color: var(--color-surface); }
        .btn-icon { flex-grow: 0; flex-shrink: 0; padding: 0; width: 52px; height: 46px; display: inline-flex; align-items: center; justify-content: center; clip-path: polygon(0 0, calc(100% - 10px) 0, 100% 10px, 100% 100%, 10px 100%, 0 calc(100% - 10px)); }
        
        .hidden-field { display: none !important; }
        .spinner { border: 4px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 1rem auto 0; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #result-panel { text-align: left; }
        .status-message { text-align: center; margin-top: 1rem; display: none; }
        .status-message.error { color: var(--color-primary); }
        .status-message.info { color: #888; }
        
        #camera-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        #camera-stream { width: 100%; max-width: 640px; height: auto; border-radius: 12px; border: 2px solid var(--color-border); }
        #camera-modal .btn-group { position: absolute; bottom: 2rem; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; }
        .btn animated-icons { width: 22px !important; height: 22px !important; transform: scale(1.2); }

        /* --- BUDGET SLIDER STYLES (ADAPTED FOR DARK THEME) --- */
        .budget-panel { background-color: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; transition: background-color 0.3s ease; }
        .budget-panel-header { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem; }
        .budget-value-display { text-align: left; }
        #budget-value { font-size: 2.5rem; font-weight: bold; color: var(--color-text); font-family: var(--font-heading); transition: color 0.3s ease; }
        #budget-value-suffix { color: var(--color-text-muted); }
        #budget-slider { -webkit-appearance: none; appearance: none; width: 100%; height: 4px; background: var(--color-border); border-radius: 2px; outline: none; cursor: pointer; }
        #budget-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; border-radius: 50%; background: var(--color-primary); cursor: pointer; border: 3px solid var(--color-surface); box-shadow: 0 0 10px rgba(255, 59, 48, 0.7); transition: transform 0.2s ease; }
        #budget-slider::-moz-range-thumb { width: 24px; height: 24px; border-radius: 50%; background: var(--color-primary); cursor: pointer; border: 3px solid var(--color-surface); box-shadow: 0 0 10px rgba(255, 59, 48, 0.7); }
        #slider-labels { position: relative; margin-top: 0.5rem; height: 1rem; }
        #slider-labels span { position: absolute; font-size: 0.75rem; color: var(--color-text-muted); transform: translateX(-50%); }
        .budget-panel-footer { margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .e85-toggle-container { display: flex; align-items: center; gap: 0.75rem; }
        .e85-toggle { transition: all 0.3s ease; }
        .e85-toggle .dot { transition: transform 0.3s ease, background-color 0.3s ease; }
        .e85-toggle-label { position: relative; display: inline-block; width: 52px; height: 28px; background-color: var(--color-border); border-radius: 14px; cursor: pointer; transition: background-color 0.3s ease; }
        .e85-toggle-label .dot { position: absolute; content: ''; height: 22px; width: 22px; left: 3px; top: 3px; background-color: white; border-radius: 50%; transition: transform 0.3s ease; }
        #e85-toggle:checked + .e85-toggle-label { background-color: var(--color-primary); }
        #e85-toggle:checked + .e85-toggle-label .dot { transform: translateX(24px); }
        #performance-level { font-weight: bold; transition: color 0.3s ease; }
        
        .hp-meter { height: 8px; background: var(--color-border); border-radius: 4px; transition: background 0.3s ease-out; overflow: hidden; }
        .hp-meter.hide-gradient { background: transparent; border: 1px solid var(--color-border); }
        .hp-meter-fill { height: 100%; background-color: var(--color-primary); border-radius: 4px; transition: width 0.4s ease-out, background-color 0.3s ease, box-shadow 0.3s ease; }

        #package-container { display: grid; grid-template-columns: 1fr; gap: 1.5rem; margin-top: 1.5rem; }
        .package-card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 12px; overflow: hidden; transition: all 0.3s ease; transform: scale(0.98); opacity: 0.7; }
        .package-card.active { transform: scale(1); opacity: 1; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4); border-color: var(--color-primary); }
        .package-card.full-width { grid-column: 1 / -1; transform: scale(1) !important; opacity: 1 !important; }
        .package-card-content { padding: 1.5rem; }

        .collapsible-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; cursor: pointer; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out; }
        .collapsible-content.active { max-height: 1000px; }
        .collapsible-content .content-inner { border-top: 1px solid var(--color-border); padding: 1.5rem; }
        .collapsible-header i { transition: transform 0.3s ease-out; }
        .rotate-180 { transform: rotate(180deg); }

        .parts-toggle-btn { width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background-color: var(--color-background); border-radius: 6px; border: 1px solid var(--color-border); cursor: pointer; transition: background-color 0.2s ease; }
        .parts-toggle-btn:hover { background-color: #2a2a2a; }
        .parts-toggle-btn i { transition: transform 0.3s ease; }
        .parts-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out; }
        .parts-content.active { max-height: 1000px; }
        .parts-content ul { list-style: disc; margin-top: 1rem; padding-left: 1.5rem; color: var(--color-text); }
        
        @keyframes shake { 0% { transform: translate(0, 0); } 25% { transform: translate(-2px, -2px); } 50% { transform: translate(2px, 2px); } 75% { transform: translate(-2px, 2px); } 100% { transform: translate(0, 0); } }
        .hp-meter-fill.shake-animation { animation: shake 0.2s ease-in-out; }
        @keyframes wiggle { 0% { transform: translate(0, 0); } 25% { transform: translate(-2px, 2px); } 50% { transform: translate(2px, -2px); } 75% { transform: translate(-2px, -2px); } 100% { transform: translate(0, 0); } }
        @keyframes hp-wiggle { 0% { transform: translateY(0) translateX(0); } 25% { transform: translateY(-1px) translateX(1px); } 50% { transform: translateY(1px) translateX(-1px); } 75% { transform: translateY(-1px) translateX(-1px); } 100% { translateY(0) translateX(0); } }
        .budget-wiggle { animation: wiggle var(--wiggle-duration, 0.6s) ease-in-out infinite alternate; display: inline-block; }
        .hp-meter-fill.hp-wiggle { animation: hp-wiggle var(--hp-wiggle-duration, 0.6s) ease-in-out infinite alternate; }
        
        /* Lava Text Gradient */
        @keyframes lavaFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .lava-text {
          background: linear-gradient(
            90deg,
            #8b0000,
            #d80000,
            #ff2a00,
            #d80000,
            #8b0000
          );
          background-size: 300%;
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          animation: lavaFlow 4s ease-in-out infinite;
        }

        /* QR Code Tooltip Styles */
       .call-link-container {
            position: relative;
            display: inline-flex;
            justify-content: center;
       }
       .call-link {
            display: inline-flex;
            align-items: center;
            color: var(--color-primary);
            text-decoration: none;
            font-family: var(--font-body);
            font-size: 0.9rem;
            transition: color 0.3s ease;
            text-transform: none;
       }
       .call-link:hover { color: var(--color-text); }
       .call-link animated-icons { width: 22px !important; height: 22px !important; margin-right: 6px; }
       .qr-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            margin-bottom: 12px;
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 0.75rem;
            z-index: 10;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
            pointer-events: none;
            width: auto;
       }
       .qr-tooltip.active {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
       }
       .qr-tooltip::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 8px;
            border-style: solid;
            border-color: var(--color-border) transparent transparent transparent;
       }
       .qr-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: -1px;
            border-width: 7px;
            border-style: solid;
            border-color: var(--color-surface) transparent transparent transparent;
       }

        /* Downward Tooltip for Welcome Page */
       #call-link-welcome .qr-tooltip {
            top: 100%;
            bottom: auto;
            margin-top: 12px;
            margin-bottom: 0;
            transform: translateX(-50%) translateY(-10px);
       }
       #call-link-welcome .qr-tooltip.active {
            transform: translateX(-50%) translateY(0);
       }
       #call-link-welcome .qr-tooltip::before {
            bottom: 100%;
            top: auto;
            border-color: transparent transparent var(--color-border) transparent;
       }
       #call-link-welcome .qr-tooltip::after {
            bottom: 100%;
            top: auto;
            margin-bottom: -1px;
            margin-top: 0;
            border-color: transparent transparent var(--color-surface) transparent;
       }

        /* --- NEW STYLES FOR THANK YOU PAGE --- */
        .panel-thank-you {
            border-radius: 12px;
            border: 1px solid var(--color-border);
            opacity: 1;
            overflow: hidden;
            --overlay-opacity: 0;
        }
        
        .panel-thank-you::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000;
            opacity: var(--overlay-opacity);
            pointer-events: none;
            z-index: 1;
            transition: opacity 0.1s linear;
        }

        .panel-thank-you .panel-content {
            position: relative;
            z-index: 2;
        }
        
        #thank-you-container .step-header p {
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            min-height: 24px;
            animation: hover-bounce 3s ease-in-out infinite;
        }

        #icon-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        #icon-container .icon-wrapper {
            filter: drop-shadow(0 0 16px rgba(255, 59, 48, var(--icon-glow-opacity, 0)));
            transition: filter 0.1s linear;
        }

        @keyframes slickBounceIn {
             0% { opacity: 0; transform: translateY(30px) scale(0.8); }
             70% { opacity: 1; transform: translateY(-10px) scale(1.05); }
             100% { transform: translateY(0) scale(1); }
        }
        @keyframes slickFadeOut {
             to { opacity: 0; transform: scale(0.8); }
        }
        .icon-in { animation: slickBounceIn 0.6s var(--ease-out-heavy) forwards; }
        .icon-out { animation: slickFadeOut 0.4s ease-out forwards; }
        
        .progress-bar-container {
            width: 200px;
            height: 2px;
            background-color: var(--color-border);
            border-radius: 4px;
            margin: 1.5rem auto;
            transition: width 0.8s var(--ease-out-heavy), height 0.6s var(--ease-out-heavy) 0.2s, margin 0.8s var(--ease-out-heavy);
        }
        .progress-bar-container.expanded {
            width: 100%;
            height: 8px;
            margin: 1.5rem 0;
        }

        #countdown-bar {
            width: 0%;
            height: 100%;
            background-color: white;
            border-radius: 4px;
            --glow-opacity: 0;
            animation: pulseBarGlow 3s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
        }
        
        .animated-text-container .cursor {
            display: inline-block;
            background-color: var(--color-text-muted);
            width: 2px;
            height: 1em;
            margin-left: 4px;
            animation: blink 1s infinite;
        }

        @keyframes blink { 50% { opacity: 0; } }
        @keyframes hover-bounce { 50% { transform: translateY(-3px); } }
        
        @keyframes pulseBarGlow {
            0%, 100% { filter: drop-shadow(0 0 8px rgba(255, 59, 48, var(--glow-opacity))); }
            50% { filter: drop-shadow(0 0 16px rgba(255, 59, 48, var(--glow-opacity))); }
        }

        .prep-asset {
            text-align: left;
            margin-top: 2rem;
            opacity: 0;
            transform: scale(0.95);
            transform-origin: top center;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.7s var(--ease-out-heavy), opacity 0.5s ease-out, transform 0.7s var(--ease-out-heavy);
        }
        
        .prep-asset.is-visible {
            opacity: 1;
            transform: scale(1);
            max-height: 100px;
        }

        .prep-asset.full-reveal {
            max-height: 500px;
        }

        .prep-asset .inner-card {
             background: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            transition: padding 0.7s var(--ease-out-heavy);
        }
        .prep-asset.full-reveal .inner-card {
             padding: 2rem;
        }

        .prep-asset .expert-bio,
        .prep-asset .next-steps-list {
            display: none;
            opacity: 0;
        }

        .prep-asset.full-reveal .expert-bio {
            display: flex;
            opacity: 1;
        }
        .prep-asset.full-reveal .next-steps-list {
            display: block;
            opacity: 1;
        }
        
        .prep-asset.full-reveal [data-revealed] {
            opacity: 0;
            animation: content-fade-in 0.6s var(--ease-out-heavy) forwards;
        }

        .prep-asset.full-reveal .expert-bio { animation-delay: 0.2s; }
        .prep-asset.full-reveal .next-steps-list li:nth-of-type(1) { animation-delay: 0.4s; }
        .prep-asset.full-reveal .next-steps-list li:nth-of-type(2) { animation-delay: 0.5s; }
        .prep-asset.full-reveal .next-steps-list li:nth-of-type(3) { animation-delay: 0.6s; }


        #prep-asset-title {
            font-size: 1.5rem;
            margin-top: 0;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-family: var(--font-heading);
            text-transform: uppercase;
        }

        #prep-asset-icon-container {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes content-fade-in {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .expert-bio {
            align-items: center;
            gap: 1.5rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--color-border);
            display: flex;
        }
        .expert-image-card {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 1px solid var(--color-border);
            background: radial-gradient(circle at bottom, var(--gradient-glow-color, rgba(255, 255, 255, 0.4)), transparent 70%), var(--color-background);
            overflow: hidden;
            flex-shrink: 0;
        }
        .expert-image-card img {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
            transform: scale(1.5);
        }
        .expert-info strong { display: block; font-size: 1.1rem; font-weight: 600; text-transform: none; }
        .expert-info span { font-size: 0.9rem; color: var(--color-text-muted); }

        .next-steps-list {
            list-style-type: none;
            padding-left: 0;
            margin-top: 1.5rem;
        }
        .next-steps-list li { display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 1rem; }
        .next-steps-list i { color: var(--color-primary); margin-top: 5px; }
        
        .fas.fa-check-circle { color: var(--color-tertiary); }
        
        @media (max-width: 768px) {
            .panel { padding: 1.5rem; }
            .step-header h2 { font-size: 2rem; }
            .btn-group { flex-direction: column; }
            .vin-input-group { flex-wrap: wrap; }
            .vin-input-group .form-control { width: 100%; margin-bottom: 0.5rem; }
            .vin-input-group .btn-icon { flex-grow: 1; }
            .budget-panel-header { flex-direction: column; align-items: flex-start; }
            .budget-value-display { text-align: left; }
            #slider-labels .intermediate-label { display: none; }
        }
        
        @media (max-width: 640px) {
            .panel-thank-you.panel { padding: 1.5rem; }
            #thank-you-container-animated .step-header h2 { font-size: 2rem; }
            .prep-asset.full-reveal .inner-card { padding: 1.5rem; }
            .expert-bio {
                flex-direction: column;
                text-align: center;
            }
            .expert-image-card {
                margin-bottom: 1rem;
            }
        }

        /* --- Star Rating Animation Classes --- */
        .star-container-fade-in {
            opacity: 0;
            animation: starFadeIn 0.5s cubic-bezier(0.1, 1.2, 0, 1) forwards; /* Aggressive easing */
        }
        .star-glow-pulse {
            animation: pulseGlow 3s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite; /* Aggressive easing */
        }
        .star-gradient-pulse {
            --center-opacity: 0.7; /* Set initial state */
            animation: pulseGradient 3s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite; /* Aggressive easing */
        }
        .glint-wrapper {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>');
            mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>');
            -webkit-mask-size: contain; mask-size: contain;
            -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat;
            -webkit-mask-position: center; mask-position: center;
        }
        .glint-wrapper::after {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(115deg, transparent 40%, rgba(255, 255, 255, 0.6) 50%, transparent 60%);
            background-size: 200% 100%;
            background-position: 200% 0;
            animation: glintWipe 5s infinite;
            animation-delay: var(--glint-delay, 0s);
        }

        /* --- Star Rating Keyframes --- */
        @keyframes starFadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to   { opacity: 1; transform: scale(1); }
        }
        @keyframes pulseGlow {
            0%, 100% { filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.7)); }
            50% { filter: drop-shadow(0 0 16px rgba(251, 191, 36, 1)); }
        }
        @keyframes pulseGradient {
            0%, 100% { --center-opacity: 0.7; }
            50% { --center-opacity: 1; }
        }
        @keyframes glintWipe {
            0%   { background-position: 200% 0; }
            5%   { background-position: 200% 0; }
            25%  { background-position: -200% 0; } /* Slowed down wipe */
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>

    <!-- SVG Definitions for Star Rating -->
    <svg style="width:0;height:0;position:absolute;" aria-hidden="true" focusable="false">
        <defs>
            <radialGradient id="starGradient3D">
                <stop offset="0%" stop-color="white" stop-opacity="var(--center-opacity, 0.7)"/>
                <stop offset="20%" stop-color="#FDE047" />
                <stop offset="90%" stop-color="#F59E0B" />
            </radialGradient>
        </defs>
    </svg>

    <div class="widget-container">
        
        <div id="questionnaire-container" class="active">
            <div class="progress-bar" id="progress-bar">
                <div class="progress-step active" data-step="1"><div class="step-node"></div>Your Info</div>
                <div class="progress-step" data-step="2"><div class="step-node"></div>Results</div>
            </div>

            <form id="tuning-form">
                <div id="step-1" class="form-step active">
                    <div class="panel">
                        <div class="step-header">
                            <h2 id="welcome-title">WIKD Tuning Configurator</h2>
                            <p id="welcome-subtitle">Find the perfect performance package for your vehicle. Let's get started!</p>
                            <div class="call-link-container" id="call-link-welcome">
                                <a href="tel:+14692498400" class="call-link">
                                    <animated-icons
                                        src="https://animatedicons.co/get-icon?name=Calling%20V3&style=minimalistic&token=66ff3706-138c-41fa-a993-dee03566e48c"
                                        trigger="loop"
                                        attributes='{"variationThumbColour":"#d80000","variationName":"Dark","variationNumber":4,"numberOfGroups":2,"strokeWidth":1.5,"backgroundIsGroup":true,"defaultColours":{"group-1":"#d80000","group-2":"#d80000","background":"#0A0A0A"}}'
                                        height="22"
                                        width="22">
                                    </animated-icons>
                                    <span class="lava-text">or give us a ring, we’re open!</span>
                                </a>
                                <div class="qr-tooltip">
                                    <canvas class="qr-code-canvas"></canvas>
                                    <p>Scan to call us!</p>
                                </div>
                            </div>
                        </div>
                        
                        <h3 style="text-align: left; margin-bottom: 1.5rem; font-size: 1.5rem;">Your Info</h3>
                        <div class="form-group">
                             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                 <div>
                                     <label for="customer-first-name">First Name</label>
                                     <input type="text" id="customer-first-name" name="customer_first_name" class="form-control" required placeholder="e.g., John">
                                 </div>
                                 <div>
                                     <label for="customer-last-name">Last Name</label>
                                     <input type="text" id="customer-last-name" name="customer_last_name" class="form-control" required placeholder="e.g., Doe">
                                 </div>
                             </div>
                        </div>
                         <div class="form-group">
                             <label for="customer-email">Email Address</label>
                             <input type="email" id="customer-email" name="customer_email" class="form-control" required placeholder="e.g., alex@email.com">
                         </div>
                         <div class="form-group">
                             <label for="customer-phone">Phone Number</label>
                             <input type="tel" id="customer-phone" name="customer_phone" class="form-control" required placeholder="e.g., (555) 123-4567">
                         </div>
                         
                         <h3 style="text-align: left; margin-top: 2.5rem; margin-bottom: 1.5rem; font-size: 1.5rem; border-top: 1px solid var(--color-border); padding-top: 2rem;">Vehicle Details</h3>

                         <div class="form-group">
                            <label>Entry Method</label>
                            <div class="choice-group" id="entry-method-choice-group">
                                <div><input type="radio" id="entry-manual" name="entry_method" value="manual" class="choice-input" checked><label for="entry-manual" class="choice-label"><span>Manual</span></label></div>
                                <div><input type="radio" id="entry-vin" name="entry_method" value="vin" class="choice-input"><label for="entry-vin" class="choice-label"><span>Use VIN</span></label></div>
                            </div>
                        </div>
                        
                        <div id="vin-entry-container" class="hidden-field">
                             <div class="form-group">
                                 <label for="vin-input-lookup">Enter Your 17-Digit VIN</label>
                                 <div class="vin-input-group">
                                     <input type="text" id="vin-input-lookup" class="form-control" placeholder="XXXXXXXXXXXXXXXXX" maxlength="17" style="text-transform: uppercase;">
                                     <button type="button" class="btn btn-icon" id="snap-vin-btn" title="Scan VIN with Camera"><i class="fas fa-camera"></i></button>
                                     <button type="button" class="btn btn-icon" id="upload-vin-btn" title="Upload VIN Image"><i class="fas fa-upload"></i></button>
                                     <input type="file" id="upload-vin-image-input" accept="image/*" class="hidden-field"/>
                                 </div>
                             </div>
                             <div class="btn-group" style="justify-content: flex-end;">
                                 <button type="button" class="btn btn-primary-filled btn-right" id="decode-vin-btn" style="flex-grow: 0.5;"><span><i class="fas fa-search"></i> Look Up</span></button>
                             </div>
                             <div id="vin-loader" class="hidden-field"><div class="spinner"></div></div>
                             <p id="vin-status" class="status-message"></p>
                        </div>
                        
                        <div id="manual-entry-container">
                            <div class="form-group">
                                <label for="make">Make</label>
                                <select id="make" name="make" class="form-control" required><option value="">-- Select Make --</option></select>
                            </div>
                            <div class="form-group">
                                <label for="model">Model</label>
                                <select id="model" name="model" class="form-control" required disabled><option value="">-- Select Make First --</option></select>
                            </div>
                             <div class="form-group">
                                 <label for="year">Year</label>
                                 <select id="year" name="year" class="form-control" required><option value="">-- Select Model First --</option></select>
                             </div>
                            <div class="form-group hidden-field" id="trim-group">
                                <label for="trim">Trim</label>
                                <select id="trim" name="trim" class="form-control" disabled><option value="">-- Select Trim --</option></select>
                            </div>
                            
                        </div>

                        <div class="btn-group">
                            <button type="button" class="btn btn-primary next-btn btn-right" id="get-results-btn" style="flex-grow: 1; clip-path: polygon(0px 0px, 100% 0px, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0px 100%);">
                                <span>Get Results</span>
                                <i class="fas fa-bolt"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="step-2" class="form-step">
                    <div class="panel" id="result-panel">
                        </div>
                </div>

            </form>
        </div>

        <!-- Animated Thank You Page (Business Hours) -->
        <div id="thank-you-container-animated" class="hidden-field">
            <div class="panel panel-thank-you">
                <div class="panel-content">
                    <div id="icon-container"></div>
                    <div class="step-header" style="margin-bottom: 1rem;">
                        <h2 id="thank-you-title">Get Ready, <span class="user-name"></span>!</h2>
                        <p id="thank-you-subtitle"><span class="animated-text-container"></span></p>
                    </div>

                    <div class="progress-bar-container">
                        <div id="countdown-bar"></div>
                    </div>

                    <div class="prep-asset">
                        <div class="inner-card">
                            <h3 id="prep-asset-title">
                                <div id="prep-asset-icon-container"></div>
                                <span id="prep-asset-title-text"></span>
                            </h3>
                            <div class="expert-bio" data-revealed>
                                <div class="expert-image-card">
                                    <img id="expert-img" src="https://cdn.shopify.com/s/files/1/0671/4635/0805/files/image_ce4ff725-5c1e-435a-9295-2fdd17e28cd8.png?v=1758904548" alt="WIKD Performance Expert">
                                </div>
                                <div class="expert-info" data-revealed>
                                    <strong>You'll be speaking with Thomas</strong>
                                    <span>Lead Performance Consultant</span>
                                </div>
                            </div>
                            <ul class="next-steps-list">
                                <li data-revealed><i class="fas fa-list-alt"></i><div><strong>Recap Your Build:</strong> Have your goals and selections fresh in your mind for the call.</div></li>
                                <li data-revealed><i class="fas fa-question-circle"></i><div><strong>Prepare Your Questions:</strong> Jot down anything you're curious about—no question is too small.</div></li>
                                <li data-revealed><i class="fas fa-car"></i><div><strong>Get Excited:</strong> You're one step closer to the ultimate driving experience.</div></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Static Thank You Page (Outside Business Hours) -->
        <div id="thank-you-container-static" class="hidden-field">
            <div class="panel" style="text-align: center; border-radius: 12px; border: 1px solid var(--color-border);">
                <div style="display: flex; justify-content: center;">
                    <animated-icons
                        src="https://animatedicons.co/get-icon?name=High%20Five&style=minimalistic&token=dfda27f9-e133-49e0-bf9e-4d952d0ab596"
                        trigger="loop"
                        attributes='{"variationThumbColour":"#FF3B30","variationName":"Dark","variationNumber":4,"numberOfGroups":2,"strokeWidth":1.5,"backgroundIsGroup":true,"defaultColours":{"group-1":"#FF3B30","group-2":"#EAEAEA","background":"#141414"}}'
                        height="200"
                        width="200">
                    </animated-icons>
                </div>
                <div class="step-header" style="margin-bottom: 1rem;">
                    <h2 style="margin-bottom: 0.5rem;">Appointment Set, <span class="user-name"></span>!</h2>
                    <p>A performance expert will call you during our next business hours (Mon-Fri, 9am-5pm).</p>
                </div>
                <div class="call-link-container" style="justify-content: center;">
                    <a href="tel:+14692498400" class="call-link">
                        <animated-icons
                            src="https://animatedicons.co/get-icon?name=Calling%20V3&style=minimalistic&token=66ff3706-138c-41fa-a993-dee03566e48c"
                            trigger="loop"
                            attributes='{"variationThumbColour":"#d80000","variationName":"Dark","variationNumber":4,"numberOfGroups":2,"strokeWidth":1.5,"backgroundIsGroup":true,"defaultColours":{"group-1":"#d80000","group-2":"#d80000","background":"#0A0A0A"}}'
                            height="22"
                            width="22">
                        </animated-icons>
                        <span class="lava-text">Need to talk sooner? Give us a ring!</span>
                    </a>
                    <div class="qr-tooltip">
                        <canvas class="qr-code-canvas"></canvas>
                        <p>Scan to call us!</p>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <div id="camera-modal" class="hidden-field">
        <video id="camera-stream" playsinline></video>
        <canvas id="snapshot-canvas" class="hidden-field"></canvas>
        <div class="btn-group">
            <button type="button" class="btn" id="close-camera-btn"><span><i class="fas fa-times"></i> Close</span></button>
            <button type="button" class="btn btn-primary" id="capture-btn"><span><i class="fas fa-camera"></i> Snap Picture</span></button>
        </div>
    </div>
    
    <script>
      const __firebase_config = JSON.stringify({
        apiKey: "AIzaSyAWX6sYYsa-scVrg2Ctjob04AHqxorq8Fs",
        authDomain: "wikdconfigurators.firebaseapp.com",
        projectId: "wikdconfigurators",
        storageBucket: "wikdconfigurators.firebasestorage.app",
        messagingSenderId: "623427770699",
        appId: "1:623427770699:web:ec24e40cb6501c047e30ce",
        measurementId: "G-8LDR50LHD3"
      });
    </script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    // --- FIREBASE VARIABLES ---
    let db, auth;
    let sessionId = null;
    let isFirebaseReady = false;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // --- MASTER DATA ---
    let packages = {};
    const domesticTuningStages = [
        { id: 'stage1', title: 'STAGE 1', price: 1000, mods: 'STOCK TO BOLTONS < 500 WHP', description: 'Visual pre-dyno inspection, baseline dyno runs, and ECU/TCU calibration tailored specifically for your vehicle and modifications. Dyno sheets displaying before & after results included.', note: '' },
        { id: 'stage2', title: 'STAGE 2', price: 1250, mods: '500HP+ INCLUDING ALT FUELS (E85, METHANOL, RACEGAS)', description: 'Stage 2 tuning includes everything from Stage 1 with enhanced calibrations for alternative fuels and performance-driven transmission tuning.', note: 'STAGE 2 provides aggressive ECU/TCU configurations advantageous for alternative fuel setups and performance modifications.' },
        { id: 'stage3', title: 'STAGE 3', price: 1500, mods: '800HP+ including ALT FUELS & POWER ADDERS', description: 'Comprehensive calibration for cars with extensive mods, multi-fuel systems, boost configurations, or large power adders (superchargers, turbos, or nitrous).', note: 'STAGE 3 is the ultimate track-level calibration service, delivering maximum safe power and performance tailored to the enthusiast’s exact specification.' },
        { id: 'wikd-tune', title: 'WIKD TUNE', price: 1750, mods: '1000HP+ RACE APPLICATIONS', description: 'The WIKD TUNE covers complete calibration on competition-level builds, with dedicated remote support and revision services for continuous fine-tuning.', note: 'REMOTE SUPPORT & custom revisions available at additional cost.<br>CALL FOR DETAILS: +1 469-249-8400' }
    ];
    const euroImportTuningStages = [
        { id: 'stage1', title: 'STAGE 1', price: 1250, mods: 'STOCK TO BOLT ON MODIFICATIONS', description: "Comprehensive dyno inspection, baseline runs, ECU/TCU calibration tailored specifically to your car’s modifications for maximum drivability and performance. You'll receive before and after dyno sheets.", note: '' },
        { id: 'stage2', title: 'STAGE 2', price: 1500, mods: 'FREE FLOWING EXHAUST & FLOWING INTAKE(S)', description: 'Stage 2 includes everything from Stage 1 plus more aggressive calibrations for enhanced performance and alternative-fuel configurations. Transmission tuning is optimized based on your driving or racing goals.', note: 'Stage 2 pushes additional limits for alternative fuel setups—ideal for enthusiasts serious about performance upgrades and tuning potential.' },
        { id: 'stage3', title: 'STAGE 3', price: 1750, mods: 'UPGRADED TURBO(S), POWER ADDERS, ALT FUELS', description: 'Stage 3 provides ultimate tuning customization, ideal for heavily modified builds. Extensive calibration across multiple fuels, boost levels, and aggressive transmission settings ensure maximum reliable performance.', note: 'Tailor-made tuning designed specifically for serious performance enthusiasts and racers seeking maximum consistency, reliability, and power.' },
        { id: 'wikd-tune', title: 'WIKD TUNE', price: 2000, mods: '1000HP+ RACE APPLICATIONS', description: 'Exclusive tuning package designed for high-horsepower race applications. Includes everything in previous stages plus comprehensive remote tuning support and revisions to keep peak performance.', note: 'Remote support available at additional cost. Call us at +1 469-249-8400 for info.' }
    ];
    
    // --- FORM ELEMENTS ---
    const form = document.getElementById('tuning-form');
    const getResultsBtn = document.getElementById('get-results-btn');
    const steps = document.querySelectorAll('.form-step');
    const progressBar = document.getElementById('progress-bar');
    const progressSteps = document.querySelectorAll('.progress-step');
    
    // --- UI ELEMENTS ---
    const userNameSpans = document.querySelectorAll('.user-name');
    const questionnaireContainer = document.getElementById('questionnaire-container');
    const vinInput = document.getElementById('vin-input-lookup');
    const decodeVinBtn = document.getElementById('decode-vin-btn');
    const vinLoader = document.getElementById('vin-loader');
    const vinStatus = document.getElementById('vin-status');
    const uploadVinImageInput = document.getElementById('upload-vin-image-input');
    const uploadVinBtn = document.getElementById('upload-vin-btn'); 
    const thankYouContainer = document.getElementById('thank-you-container');
    const entryMethodRadios = document.querySelectorAll('input[name="entry_method"]');
    const manualEntryContainer = document.getElementById('manual-entry-container');
    const vinEntryContainer = document.getElementById('vin-entry-container');
    const snapVinBtn = document.getElementById('snap-vin-btn');
    const cameraModal = document.getElementById('camera-modal');
    const cameraStream = document.getElementById('camera-stream');
    const captureBtn = document.getElementById('capture-btn');
    const closeCameraBtn = document.getElementById('close-camera-btn');
    const snapshotCanvas = document.getElementById('snapshot-canvas');
    let currentStream = null;
    const callLinks = document.querySelectorAll('.call-link');

    // --- STATE ---
    let currentStep = 1;
    let userVin = null;
    let userFirstName = '';
    let selectedItems = []; 
    let currentVehiclePackages = [];
    const phoneNumber = '+14692498400';

    // === VEHICLE SELECTOR LOGIC ===
    const API_BASE = 'https://vpic.nhtsa.dot.gov/api/vehicles';
    const makeSelect = document.getElementById('make');
    const modelSelect = document.getElementById('model');
    const yearSelect = document.getElementById('year');
    const trimGroup = document.getElementById('trim-group');
    const trimSelect = document.getElementById('trim');
    const priorityMakes = ['Audi','Cadillac','Chevrolet','Ferrari','Lamborghini','Mclaren'];
    const makeRegionMap = { 'gmc': 'us-domestic', 'cadillac':'us-domestic', 'chevrolet':'us-domestic', 'audi':'euro', 'alfaromeo':'euro', 'astonmartin':'euro', 'bentley':'euro', 'bmw':'euro', 'bugatti':'euro', 'ferrari':'euro', 'jaguar':'euro', 'koenigsegg':'euro', 'lamborghini':'euro', 'lotus':'euro', 'mclaren':'euro', 'mercedesbenz':'euro', 'pagani':'euro', 'rollsroyce':'euro', 'acura':'jdm', 'honda':'jdm', 'infiniti':'jdm', 'lexus':'jdm', 'nissan':'jdm', 'toyota':'jdm', 'kia':'korean' };
    const manualCadillacModels = [ {name:'CT5-V Blackwing', hasPackage:true}, {name:'CTS-V', hasPackage:true}, {name:'CT4-V Blackwing', hasPackage:false}, {name:'Escalade', hasPackage:false} ];
    const makeModelPackages = {
        'cadillac': { 'ct5vblackwing': true, 'ctsv': true },
        'chevrolet': { 'corvette': true, 'camaro': true }
    };
    const modelTrims = { 'chevrolet': { 'corvette': ['Base','Z06','ZR1','Stingray','Grand Sport','E-Ray'], 'camaro': ['Gen 5','Gen 6 SS','Gen 6 ZL1'] }, 'lamborghini': { 'huracan': ['EVO','STO'] } };
    
    // --- FIREBASE & SESSION ---
    function setCookie(name, value, days) { let expires = ""; if (days) { const date = new Date(); date.setTime(date.getTime() + (days*24*60*60*1000)); expires = "; expires=" + date.toUTCString(); } document.cookie = name + "=" + (value || "")  + expires + "; path=/; SameSite=Lax"; }
    function getCookie(name) { const nameEQ = name + "="; const ca = document.cookie.split(';'); for(let i=0; i < ca.length; i++) { let c = ca[i]; while (c.charAt(0)==' ') c = c.substring(1,c.length); if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length); } return null; }
    function generateUUID() { return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)); }
    
    async function saveStateToFirebase() {
        if (!isFirebaseReady || !sessionId) return;
        try {
            const sanitizedSelectedItems = JSON.parse(JSON.stringify(selectedItems));
            const state = {
                firstName: document.getElementById('customer-first-name').value || null,
                vin: userVin || null,
                make: makeSelect.value || null,
                model: modelSelect.value || null,
                year: yearSelect.value || null,
                trim: trimSelect.value || null,
                selectedItems: sanitizedSelectedItems,
                currentStep: currentStep || 1,
                customerFirstName: document.getElementById('customer-first-name').value || null,
                customerLastName: document.getElementById('customer-last-name').value || null,
                customerEmail: document.getElementById('customer-email').value || null,
                customerPhone: document.getElementById('customer-phone').value || null,
                lastUpdated: new Date().toISOString()
            };
            await db.collection(`/artifacts/${appId}/public/data/submissions`).doc(sessionId).set(state, { merge: true });
        } catch (error) { console.error("Error saving state to Firebase: ", error); }
    }

    async function loadStateFromFirebase(sid) {
        if (!isFirebaseReady || !sid) return;
        try {
            const docRef = db.collection(`/artifacts/${appId}/public/data/submissions`).doc(sid);
            const docSnap = await docRef.get();
            if (docSnap.exists) {
                const state = docSnap.data();
                userVin = state.vin || null;
                if(state.customerFirstName) document.getElementById('customer-first-name').value = state.customerFirstName;
                if(state.customerLastName) document.getElementById('customer-last-name').value = state.customerLastName;
                if(state.customerEmail) document.getElementById('customer-email').value = state.customerEmail;
                if(state.customerPhone) document.getElementById('customer-phone').value = state.customerPhone;
                if (state.make) {
                    makeSelect.value = state.make;
                    await loadModelsForMake(state.make);
                    if (state.model) { modelSelect.value = state.model; modelSelect.dispatchEvent(new Event('change')); }
                    if(state.year) yearSelect.value = state.year;
                    if(state.trim) trimSelect.value = state.trim;
                }
                selectedItems = state.selectedItems || [];
                if (state.currentStep) {
                    validateAndStoreName();
                    updateStep(state.currentStep, true); 
                    if(state.currentStep >= 2) initializeResultsPage();
                }
            }
        } catch (error) { console.error("Error loading state from Firebase:", error); }
    }

    // --- HELPERS ---
    function normalizeKey(str){ return String(str||'').toLowerCase().replace(/\s+/g,'').replace(/-/g,'').replace(/[^a-z0-9]/g,''); }
    function toTitleCase(str){ return String(str||'').toLowerCase().replace(/\b\w/g,c=>c.toUpperCase()); }
    function isMobileDevice() { return ('ontouchstart' in window) || (navigator.maxTouchPoints > 0); }

    // --- UI LOGIC ---
    async function loadCarMakes(){
        try{
            const res=await fetch(`${API_BASE}/GetMakesForVehicleType/car?format=json`);
            if (!res.ok) throw new Error(`API Error: ${res.status}`);
            const data=await res.json();
            makeSelect.innerHTML='<option value="">-- Select Make --</option>'; 
            const apiMakes=data.Results.map(m=>({raw:m.MakeName, key:normalizeKey(m.MakeName)}));
            const added=new Set();
            priorityMakes.forEach(pm => {
                const nk=normalizeKey(pm); if(!makeRegionMap[nk]) return;
                const apiMatch=apiMakes.find(x=>x.key===nk); const opt=document.createElement('option'); opt.value=apiMatch?apiMatch.raw:pm; opt.textContent=toTitleCase(opt.value); opt.className='top-highlight'; makeSelect.appendChild(opt); added.add(nk);
            });
            const sep=document.createElement('option');sep.textContent='──────────';sep.disabled=true;sep.className='separator';makeSelect.appendChild(sep);
            const others=apiMakes.filter(x=>!added.has(x.key) && makeRegionMap[x.key]).sort((a,b)=>a.raw.localeCompare(b.raw));
            others.forEach(m => { const o=document.createElement('option'); o.value=m.raw; o.textContent=toTitleCase(m.raw); makeSelect.appendChild(o); added.add(m.key);});  
        }catch(err){ console.error('loadCarMakes error',err); makeSelect.innerHTML = '<option value="">Error Loading Makes</option>'; }
    }

    async function loadModelsForMake(makeName){
        modelSelect.innerHTML='<option value="">-- Loading Models --</option>'; 
        modelSelect.disabled=true; hideTrim();
        if(!makeName){ modelSelect.innerHTML='<option value="">-- Select Make First --</option>'; return; }
        const normalizedMake=normalizeKey(makeName);
        const makeIsPriority = priorityMakes.some(m=>normalizeKey(m)===normalizedMake);
        if(normalizedMake==='cadillac'){
            let apiModels=[];
            try{ const res=await fetch(`${API_BASE}/GetModelsForMake/${encodeURIComponent(makeName)}?format=json`); const data=await res.json(); apiModels=data.Results.map(r=>r.Model_Name);}catch(e){console.error('cadillac api models',e);}   
            const manualSet=new Set(manualCadillacModels.map(m=>normalizeKey(m.name)));
            const additional=apiModels.filter(m=>!manualSet.has(normalizeKey(m)));
            modelSelect.innerHTML = '<option value="">-- Select Model --</option>';
            manualCadillacModels.forEach(mm => { const opt=document.createElement('option'); opt.value=mm.name; opt.textContent=mm.name; if(mm.hasPackage && makeIsPriority) opt.className='model-highlight'; modelSelect.appendChild(opt);}); 
            additional.forEach(mn=>{ const opt=document.createElement('option'); opt.value=mn; opt.textContent=mn; modelSelect.appendChild(opt); });
            modelSelect.disabled=false; modelSelect.dispatchEvent(new Event('change')); return;
        }
        try{
            const res=await fetch(`${API_BASE}/GetModelsForMake/${encodeURIComponent(makeName)}?format=json`);
            if (!res.ok) throw new Error(`API Error: ${res.status}`);
            const data=await res.json();
            const packagesConfig = makeModelPackages[normalizedMake] || {};
            let withPackages=[], withoutPackages=[];
            data.Results.forEach(m=>{ const nm=normalizeKey(m.Model_Name); (packagesConfig[nm]===true) ? withPackages.push(m.Model_Name) : withoutPackages.push(m.Model_Name); });
            modelSelect.innerHTML = '<option value="">-- Select Model --</option>';
            withPackages.forEach(mn=>{ const opt=document.createElement('option'); opt.value=mn; opt.textContent=mn; if(makeIsPriority) opt.className='model-highlight'; modelSelect.appendChild(opt); });
            withoutPackages.forEach(mn=>{ const opt=document.createElement('option'); opt.value=mn; opt.textContent=mn; modelSelect.appendChild(opt); });
            if(data.Results.length===0){ modelSelect.innerHTML = '<option value="">No models found</option>';}     
            modelSelect.disabled=false; modelSelect.dispatchEvent(new Event('change'));
        }catch(err){ console.error('loadModelsForMake error',err); modelSelect.innerHTML='<option value="">Error loading models</option>'; }
    }

    function hideTrim(){ trimGroup.classList.add('hidden-field'); trimSelect.innerHTML='<option value="">-- Select Trim --</option>'; trimSelect.disabled = true; trimSelect.required = false; }
    function showTrim(trims){ trimSelect.innerHTML='<option value="">-- Select Trim --</option>'; trims.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; trimSelect.appendChild(o); }); trimGroup.classList.remove('hidden-field'); trimSelect.disabled = false; trimSelect.required = true; }
    function updateTrimDropdown(makeName, modelName){ hideTrim(); if(!makeName || !modelName) return; const nMake = normalizeKey(makeName); const nModel = normalizeKey(modelName); if((nMake === 'chevrolet' && (nModel === 'corvette' || nModel === 'camaro')) || (nMake === 'lamborghini' && nModel === 'huracan')) { const trims = modelTrims[nMake]?.[nModel]; if(trims?.length > 0) showTrim(trims); } }
    
    function validateAndStoreName() {
        const name = document.getElementById('customer-first-name').value.trim();
        if (name === '') { return false; }
        userFirstName = name;
        userNameSpans.forEach(span => { span.textContent = userFirstName; });
        return true;
    }

    entryMethodRadios.forEach(radio => { radio.addEventListener('change', function() { const isManual = this.value === 'manual'; manualEntryContainer.classList.toggle('hidden-field', !isManual); vinEntryContainer.classList.toggle('hidden-field', isManual); }); });
    function showStatus(message, isError = false, isInfo = false) { vinStatus.textContent = message; vinStatus.className = 'status-message'; if (message) { if (isError) vinStatus.classList.add('error'); if (isInfo) vinStatus.classList.add('info'); vinStatus.style.display = 'block'; } else { vinStatus.style.display = 'none'; } }

    decodeVinBtn.addEventListener('click', async () => {
        const vin = vinInput.value.trim().toUpperCase();
        if (vin.length !== 17) {
            showStatus('Please enter a valid 17-digit VIN.', true);
            return;
        }
        
        showStatus('');
        vinLoader.classList.remove('hidden-field');
        decodeVinBtn.disabled = true;

        try {
            const response = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValues/${vin}?format=json`);
            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            const data = await response.json();
            
            const result = data.Results[0];
            if (!result || !result.Make || !result.Model || !result.ModelYear) {
                 throw new Error(result.ErrorText || 'VIN not found or is missing critical data. Please fill out manually.');
            }

            const decodedMakeRaw = result.Make;
            const makeOption = Array.from(makeSelect.options).find(opt => opt.value.toLowerCase() === decodedMakeRaw.toLowerCase());

            if (!makeOption) {
                throw new Error(`Sorry, we don't have tuning data for ${toTitleCase(decodedMakeRaw)} yet. Please try another vehicle.`);
            }
            
            userVin = vin;

            makeSelect.value = makeOption.value;
            await loadModelsForMake(makeSelect.value);
            
            const modelOptions = Array.from(modelSelect.options).map(opt => opt.value);
            const decodedModel = modelOptions.find(m => m && normalizeKey(result.Model).includes(normalizeKey(m))) || modelOptions[0];
            modelSelect.value = decodedModel;

            if (yearSelect.options.length <= 1) populateYears();
            yearSelect.value = result.ModelYear;
            
            modelSelect.dispatchEvent(new Event('change'));
            yearSelect.dispatchEvent(new Event('change'));
            
            const apiTrim = result.Trim || result.Trim2 || '';
            if (apiTrim && trimSelect.options.length > 1) {
                const trimOptions = Array.from(trimSelect.options);
                let bestMatch = trimOptions.find(opt => opt.value.toLowerCase() === apiTrim.toLowerCase());
                if (!bestMatch) {
                    bestMatch = trimOptions.find(opt => opt.value && apiTrim.toLowerCase().includes(opt.value.toLowerCase()));
                }
                if (bestMatch) {
                    trimSelect.value = bestMatch.value;
                    trimSelect.dispatchEvent(new Event('change'));
                }
            }
            
            showStatus('Vehicle Found! Details have been filled in below.', false, true);
            document.getElementById('entry-manual').checked = true;
            document.getElementById('entry-manual').dispatchEvent(new Event('change'));

        } catch (error) {
            showStatus(error.message, true);
        } finally {
            vinLoader.classList.add('hidden-field');
            decodeVinBtn.disabled = false;
        }
    });
    
    // --- VIN SCANNER & CAMERA ---
    function correctVin(vin) { return vin.replace(/[^A-Z0-9]/gi, '').replace(/[OQ]/g, '0').replace(/I/g, '1').replace(/S/g, '5').replace(/B/g, '8'); }
    function extractVin(text) { const cleanedText = text.replace(/[\s\r\n-]+/g, '').toUpperCase().replace(/[^A-Z0-9]/g, ''); if (!cleanedText) return null; return correctVin(cleanedText).slice(0, 17); }
    function processImage(imageFile) { vinLoader.classList.remove('hidden-field'); showStatus('Scanning image...', false, true); decodeVinBtn.disabled = true; Tesseract.recognize(imageFile, 'eng').then(({ data: { text } }) => { const vin = extractVin(text); if (vin) { vinInput.value = vin; showStatus('Text Detected. Please verify.', false, true); } else { showStatus('VIN not detected. Please try again.', true); } }).catch(err => { console.error(err); showStatus('Error during image processing.', true); }).finally(() => { vinLoader.classList.add('hidden-field'); decodeVinBtn.disabled = false; }); }
    uploadVinBtn.addEventListener('click', () => uploadVinImageInput.click());
    uploadVinImageInput.addEventListener('change', () => { const file = uploadVinImageInput.files[0]; if (file) processImage(file); uploadVinImageInput.value = ''; });
    async function openCamera() { if (!(navigator.mediaDevices?.getUserMedia)) { showStatus('Camera not supported.', true); return; } try { currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); cameraModal.classList.remove('hidden-field'); cameraStream.srcObject = currentStream; cameraStream.play(); } catch (err) { console.error("Camera access error:", err); showStatus('Could not access camera.', true); } }
    function closeCamera() { if (currentStream) { currentStream.getTracks().forEach(track => track.stop()); } cameraModal.classList.add('hidden-field'); }
    snapVinBtn.addEventListener('click', openCamera);
    closeCameraBtn.addEventListener('click', closeCamera);
    captureBtn.addEventListener('click', () => { const context = snapshotCanvas.getContext('2d'); snapshotCanvas.width = cameraStream.videoWidth; snapshotCanvas.height = cameraStream.videoHeight; context.drawImage(cameraStream, 0, 0, snapshotCanvas.width, snapshotCanvas.height); closeCamera(); snapshotCanvas.toBlob(blob => { if (blob) processImage(blob); }, 'image/jpeg'); });

    // --- FORM EVENT LISTENERS ---
    const populateYears = () => { yearSelect.innerHTML = '<option value="">-- Select Year --</option>'; const currentYr = new Date().getFullYear(); for (let y = currentYr + 1; y >= 2005; y--) yearSelect.add(new Option(y, y)); };
    makeSelect.addEventListener('change', function() { loadModelsForMake(this.value); yearSelect.value = ''; saveStateToFirebase(); });
    modelSelect.addEventListener('change', function() { updateTrimDropdown(makeSelect.value, this.value); saveStateToFirebase(); });
    yearSelect.addEventListener('change', saveStateToFirebase);
    trimSelect.addEventListener('change', saveStateToFirebase);
    
    const updateStep = (newStep, fromLoad = false) => {
        if (!fromLoad && newStep > currentStep) {
            const inputs = steps[currentStep - 1].querySelectorAll('select[required], input[required]');
            let allValid = ![...inputs].some(input => {
                if(input.closest('.hidden-field')) return false;
                let isValid = input.value && !(input.type === 'email' && !/^\S+@\S+\.\S+$/.test(input.value));
                if (!isValid) { input.style.borderColor = 'var(--color-primary)'; setTimeout(() => input.style.borderColor = '', 2000); }
                return !isValid;
            });
            if (!allValid) return;
        }
        if(currentStep === 1 && newStep > 1) validateAndStoreName();
        steps.forEach(step => step.classList.remove('active'));
        steps[newStep - 1].classList.add('active');
        const totalSteps = progressSteps.length;
        const progressFraction = newStep > 1 ? (newStep - 1) / (totalSteps - 1) : 0;
        progressBar.style.setProperty('--progress-width', `${progressFraction * (100 - (100 / totalSteps))}%`);
        progressSteps.forEach((step, index) => {
            step.classList.remove('active', 'completed');
            if (index + 1 < newStep) step.classList.add('completed');
            else if (index + 1 === newStep) step.classList.add('active');
        });
        currentStep = newStep;
        if (!fromLoad) saveStateToFirebase();
        window.scrollTo(0, 0);
    };

    function triggerStep1WebhookAndPixel() {
        const data = {
            firstName: document.getElementById('customer-first-name').value || '',
            lastName: document.getElementById('customer-last-name').value || '',
            email: document.getElementById('customer-email').value || '',
            phone: document.getElementById('customer-phone').value || '',
            year: yearSelect.value || '',
            make: makeSelect.value || '',
            model: modelSelect.value || '',
            trim: trimSelect.value || '',
            vin: userVin || 'N/A',
            lead_stage: 'get_results_clicked'
        };

        try {
            const zapierWebhookUrl = "https://hooks.zapier.com/hooks/catch/19421224/udjefb6/";
            console.log("Sending step 1 data to partial lead Zapier:", data);
            fetch(zapierWebhookUrl, {
                method: 'POST',
                body: JSON.stringify(data),
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' }
            });
        } catch (err) {
            console.error("Error sending to partial lead Zapier:", err);
        }

        if (typeof fbq === "function") {
            fbq('track', 'Lead'); 
            console.log("Meta Pixel Lead event fired on Get Results.");
        }
    }

    getResultsBtn.addEventListener('click', () => {
        const originalStep = currentStep;
        updateStep(2);
        if (currentStep > originalStep) {
            triggerStep1WebhookAndPixel();
            initializeResultsPage();
        }
    });
    
    // --- RESULTS PAGE LOGIC ---
    function getVehicleHasPackages(data) {
        const nMake = normalizeKey(data.make);
        const nModel = normalizeKey(data.model);
        return makeModelPackages[nMake]?.[nModel] === true;
    }
    
    function getVehicleKeyForPackages(data) {
        const nModel = normalizeKey(data.model);
        const nTrim = normalizeKey(data.trim);
        const year = parseInt(data.year);

        if (nModel.includes('corvette')) return year <= 2019 ? 'Corvette_C7' : 'Corvette_C8';
        if (nModel.includes('camaro')) {
            if (nTrim === 'gen6zl1') return 'Camaro_ZL1';
            return 'Camaro';
        }
        return data.model;
    }

    function initializeResultsPage() {
        const resultPanel = document.getElementById('result-panel');
        const data = { make: makeSelect.value, model: modelSelect.value, year: yearSelect.value, trim: trimSelect.value };
        const hasPackages = getVehicleHasPackages(data);
        
        const itemsToDisplay = hasPackages ? getPackagesForVehicle(data) : getStagesForVehicle(data);
        renderSliderInterface(resultPanel, data, itemsToDisplay, hasPackages ? 'packages' : 'stages');
    }

    function getPackagesForVehicle(data) {
        const vehicleKey = getVehicleKeyForPackages(data);
        let items = packages[vehicleKey] || [];
        const WIKD_PACKAGE = { id: 'package-1000-whp', title: 'WIKD 1000+ WHP', baseTitle: 'WIKD 1000+ WHP', price: 99999, hp_delta: 1000, description: "A blank check to automotive nirvana. This build is for the enthusiast who demands nothing less than domination.", note: 'WARNING: THIS MACHINE WILL BECOME A BEAST. HANDLE WITH EXTREME CAUTION.', parts: ['Custom Forged Internal Engine', 'Custom Forced Induction', 'Reinforced Drivetrain', 'Upgraded Fuel & Cooling Systems', 'Standalone ECU', 'And much more...'], e85Compatible: false, performanceLevel: 'Insane' };
        items.push(WIKD_PACKAGE);
        return items.sort((a,b) => a.price - b.price);
    }

    function getStagesForVehicle(data) {
        const nMake = normalizeKey(data.make);
        const region = makeRegionMap[nMake] || 'unknown';
        const stages = (region === 'us-domestic') ? domesticTuningStages : euroImportTuningStages;
        return stages.map(stage => ({
            ...stage,
            baseTitle: stage.title,
            hp_delta: { 'stage1': 100, 'stage2': 250, 'stage3': 400, 'wikd-tune': 600 }[stage.id] || 50,
            parts: [stage.mods],
            e85Compatible: false,
            performanceLevel: stage.title
        }));
    }

    function renderSliderInterface(resultPanel, data, itemsToDisplay, displayType) {
        const highestNormalItemPrice = itemsToDisplay.length > 1 ? itemsToDisplay[itemsToDisplay.length - 2].price : itemsToDisplay[0].price;
        const WIKD_ITEM_PRICE = itemsToDisplay[itemsToDisplay.length - 1].price;
        const SNAP_THRESHOLD_BUDGET = highestNormalItemPrice + ((WIKD_ITEM_PRICE - highestNormalItemPrice) * 0.1);
        const sliderMap = [ { slider: 0, budget: itemsToDisplay[0].price } ];
        if (itemsToDisplay.length > 2) { const midIndex = Math.floor(itemsToDisplay.length / 2); sliderMap.push({ slider: 500, budget: itemsToDisplay[midIndex].price }); }
        sliderMap.push({ slider: 1000, budget: WIKD_ITEM_PRICE });

        resultPanel.innerHTML = `
            <div class="step-header"><h2>Select Your ${displayType === 'packages' ? 'Package' : 'Stage'}</h2><p>Use the slider to match your budget and goals</p></div>
            
            <div class="flex items-center justify-center space-x-4 mb-8">
                <div class="flex items-center space-x-1">
                    <!-- Star 1 -->
                    <a href="https://share.google/7vAZnoZqZSVFpq84p" target="_blank" rel="noopener noreferrer" class="relative block w-8 h-8 star-container-fade-in transition-transform duration-200 hover:scale-110 ease-[cubic-bezier(0.1,1.2,0,1)]" style="animation-delay: 0s;">
                        <svg class="absolute top-0 left-0 w-full h-full text-yellow-400 star-glow-pulse" style="animation-delay: 0s;" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                        <svg class="absolute top-0 left-0 w-full h-full star-gradient-pulse" style="animation-delay: 0s;" fill="url(#starGradient3D)" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                        <div class="glint-wrapper" style="--glint-delay: 1.0s;"></div>
                    </a>
                    <!-- Star 2 -->
                    <a href="https://share.google/7vAZnoZqZSVFpq84p" target="_blank" rel="noopener noreferrer" class="relative block w-8 h-8 star-container-fade-in transition-transform duration-200 hover:scale-110 ease-[cubic-bezier(0.1,1.2,0,1)]" style="animation-delay: 0.1s;">
                        <svg class="absolute top-0 left-0 w-full h-full text-yellow-400 star-glow-pulse" style="animation-delay: 0.1s;" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                        <svg class="absolute top-0 left-0 w-full h-full star-gradient-pulse" style="animation-delay: 0.1s;" fill="url(#starGradient3D)" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                        <div class="glint-wrapper" style="--glint-delay: 1.0s;"></div>
                    </a>
                    <!-- Star 3 -->
                    <a href="https://share.google/7vAZnoZqZSVFpq84p" target="_blank" rel="noopener noreferrer" class="relative block w-8 h-8 star-container-fade-in transition-transform duration-200 hover:scale-110 ease-[cubic-bezier(0.1,1.2,0,1)]" style="animation-delay: 0.2s;">
                        <svg class="absolute top-0 left-0 w-full h-full text-yellow-400 star-glow-pulse" style="animation-delay: 0.2s;" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                        <svg class="absolute top-0 left-0 w-full h-full star-gradient-pulse" style="animation-delay: 0.2s;" fill="url(#starGradient3D)" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                        <div class="glint-wrapper" style="--glint-delay: 1.0s;"></div>
                    </a>
                    <!-- Star 4 -->
                    <a href="https://share.google/7vAZnoZqZSVFpq84p" target="_blank" rel="noopener noreferrer" class="relative block w-8 h-8 star-container-fade-in transition-transform duration-200 hover:scale-110 ease-[cubic-bezier(0.1,1.2,0,1)]" style="animation-delay: 0.3s;">
                        <svg class="absolute top-0 left-0 w-full h-full text-yellow-400 star-glow-pulse" style="animation-delay: 0.3s;" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                        <svg class="absolute top-0 left-0 w-full h-full star-gradient-pulse" style="animation-delay: 0.3s;" fill="url(#starGradient3D)" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                        <div class="glint-wrapper" style="--glint-delay: 1.0s;"></div>
                    </a>
                    <!-- Partial Star 5 -->
                    <a href="https://share.google/7vAZnoZqZSVFpq84p" target="_blank" rel="noopener noreferrer" class="relative block w-8 h-8 star-container-fade-in transition-transform duration-200 hover:scale-110 ease-[cubic-bezier(0.1,1.2,0,1)]" style="animation-delay: 0.4s;">
                        <svg class="absolute top-0 left-0 w-full h-full text-yellow-400 star-glow-pulse" style="animation-delay: 0.4s;" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                        <svg class="absolute top-0 left-0 w-full h-full text-zinc-700" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                        <div class="absolute top-0 left-0 w-full h-full" style="clip-path: inset(0 40% 0 0);">
                            <svg class="w-full h-full star-gradient-pulse" style="animation-delay: 0.4s;" fill="url(#starGradient3D)" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            <div class="glint-wrapper" style="--glint-delay: 1.0s;"></div>
                        </div>
                    </a>
                </div>
                <div class="text-zinc-300 font-bold text-2xl star-container-fade-in" style="animation-delay: 0.5s;">
                    4.6 / 5
                </div>
            </div>

            <div class="budget-panel" id="budget-panel">
                <div class="budget-panel-header"><div><h2 class="text-2xl font-bold" style="text-transform: none; color: white;">Your Budget</h2></div><div class="budget-value-display"><span id="budget-value"></span><span id="budget-value-suffix">/${displayType === 'packages' ? 'package' : 'stage'}</span></div></div>
                <div class="relative"><input type="range" min="0" max="1000" step="1" value="0" id="budget-slider"><div id="slider-labels"></div></div>
                <div class="budget-panel-footer" ${displayType === 'stages' ? 'style="display:none;"' : ''}><div class="e85-toggle-container"><span class="font-medium text-sm">E85 Conversion:</span><input type="checkbox" id="e85-toggle" class="choice-input"><label for="e85-toggle" class="e85-toggle-label"><span class="dot"></span></label></div><div class="text-right"><span id="performance-level" class="font-bold"></span></div></div>
            </div>
            <div class="mb-8"><div class="hp-meter" id="hp-meter-container"><div id="hp-meter-fill" class="hp-meter-fill"></div></div></div>
            <div id="package-container"></div>
            <div class="collapsible-container panel" style="margin-top: 2rem; padding: 0; border: 1px solid var(--color-border);"><div class="collapsible-header"><h3 style="font-size: 1.2rem;">Important Notes</h3><i class="fas fa-chevron-down"></i></div><div class="collapsible-content"><div class="content-inner" style="color: var(--color-text-muted); font-size: 0.9rem;"><ul class="space-y-4" style="list-style-type: none; padding: 0; color: var(--color-text-muted);"><li>All prices are estimates and may vary.</li><li>Shop fees (supplies, hazmat, processing) are separate from package prices.</li><li>Compatibility: <span id="notes-vehicle-info"></span></li><li>Contact WIKD MOTORSPORTS at +1 469-249-8400 for a precise quote.</li></ul></div></div></div>
            <div class="btn-group"><button type="button" class="btn prev-btn btn-left"><span>Back</span></button></div>`;
        
        document.getElementById('notes-vehicle-info').textContent = `${data.year} ${data.make} ${data.model} ${data.trim}`;
        const budgetSlider = resultPanel.querySelector('#budget-slider');
        const e85Toggle = resultPanel.querySelector('#e85-toggle');
        let isSliding = false, animationFrameId = null;

        function convertSliderToBudget(value) { const segment = sliderMap.find((p, i) => value >= p.slider && value <= (sliderMap[i + 1]?.slider || 1000)); if (!segment) return sliderMap[0].budget; const nextPoint = sliderMap[sliderMap.indexOf(segment) + 1] || sliderMap[sliderMap.length-1]; const sliderRange = nextPoint.slider - segment.slider; if (sliderRange === 0) return segment.budget; const budgetRange = nextPoint.budget - segment.budget; const progress = (value - segment.slider) / sliderRange; return segment.budget + (progress * budgetRange); }
        
        function renderResults() {
            const budget = convertSliderToBudget(parseInt(budgetSlider.value));
            const e85Active = e85Toggle.checked;
            const adjustedItems = itemsToDisplay.map(p => { const title = p.baseTitle || p.title || ''; return { ...p, adjustedPrice: e85Active && p.e85Compatible ? p.price + p.e85PriceBoost : p.price, adjustedHp: e85Active && p.e85Compatible ? p.hp_delta + p.e85HpBoost : p.hp_delta, adjustedTitle: e85Active && p.e85Compatible ? title.replace(/\s*\(E85\)/i, '') + ' (E85)' : title }; });
            let activeItem = adjustedItems.filter(p => p.adjustedPrice <= budget).pop() || adjustedItems[0];
            selectedItems = [activeItem];
            const isWikdMode = activeItem.id === 'package-1000-whp' || activeItem.id === 'wikd-tune';
            resultPanel.querySelector('#budget-value').textContent = isWikdMode ? '$???,???' : `$${Math.round(budget).toLocaleString()}`;
            resultPanel.querySelector('.budget-panel').style.backgroundColor = isWikdMode ? 'rgba(255, 59, 48, 0.1)' : 'var(--color-surface)';
            resultPanel.querySelector('#performance-level').textContent = activeItem.performanceLevel;
            const maxHp = Math.max(...adjustedItems.map(p => p.hp_delta || 0));
            resultPanel.querySelector('#hp-meter-fill').style.width = `${((activeItem.adjustedHp || activeItem.hp_delta) / maxHp) * 100}%`;
            const packageContainer = resultPanel.querySelector('#package-container');
            packageContainer.innerHTML = '';
            const activeIndex = adjustedItems.findIndex(p => p.id === activeItem.id);
            const nextItem = activeIndex < adjustedItems.length - 1 ? adjustedItems[activeIndex + 1] : null;
            [activeItem, nextItem].filter(p => p).forEach((item, index) => {
                const card = document.createElement('div');
                card.className = `package-card ${index === 0 ? 'active' : ''} ${item.id === 'package-1000-whp' || item.id === 'wikd-tune' ? 'full-width' : ''}`;
                const priceString = (isWikdMode && index === 0) 
                    ? '$???,???' 
                    : `${displayType === 'stages' ? 'Starting at ' : ''}$${item.price.toLocaleString('en-US', {minimumFractionDigits: 0})}`;

                card.innerHTML = `<div class="package-card-content"><div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;"><h3 class="text-xl font-bold">${item.adjustedTitle || item.title}</h3><span class="text-xs font-semibold px-2.5 py-0.5 rounded" style="background-color: var(--color-border);">${item.performanceLevel}</span></div><div class="mb-4"><p class="text-3xl font-bold">${priceString}</p><p class="text-sm" style="color: var(--color-text-muted)">${displayType === 'packages' ? '+' + (item.adjustedHp || item.hp_delta) + ' WHP' : item.mods}</p></div><p class="text-sm" style="color: var(--color-text-muted); margin-bottom: 1rem;">${item.description}</p>${item.note ? `<div style="background-color: rgba(255, 59, 48, 0.1); border-left: 4px solid var(--color-primary); padding: 0.75rem; margin-bottom: 1rem; border-radius: 4px;"><p style="color: #ffcdd2" class="text-sm">${item.note}</p></div>` : ''}<button class="parts-toggle-btn"><span class="font-medium">${displayType === 'stages' ? 'Details' : 'Included Parts'}</span><i class="fas fa-chevron-down text-xs"></i></button><div class="parts-content"><ul>${(item.parts || []).map(part => `<li>${part}</li>`).join('')}</ul></div>${index === 0 ? `<button type="button" class="btn btn-primary submit-inquiry-btn" style="margin-top: 1rem; width: 100%; clip-path: none; border-radius: 8px;"><span>Submit Inquiry</span></button>` : ''}</div>`;
                packageContainer.appendChild(card);
            });
        }

        function animateSliderTo(targetValue, duration = 400) { if (animationFrameId) cancelAnimationFrame(animationFrameId); const startValue = parseInt(budgetSlider.value), distance = targetValue - startValue; let startTime = null; function step(currentTime) { if (isSliding) { cancelAnimationFrame(animationFrameId); return; } if (!startTime) startTime = currentTime; const elapsed = currentTime - startTime, progress = Math.min(elapsed / duration, 1), eased = 1 - Math.pow(1 - progress, 3); budgetSlider.value = startValue + distance * eased; renderResults(); if (progress < 1) animationFrameId = requestAnimationFrame(step); } animationFrameId = requestAnimationFrame(step); }
        function handleSliderRelease() { isSliding = false; if (convertSliderToBudget(parseInt(budgetSlider.value)) >= SNAP_THRESHOLD_BUDGET) animateSliderTo(1000); }
        budgetSlider.addEventListener('input', renderResults);
        budgetSlider.addEventListener('mousedown', () => { isSliding = true; if (animationFrameId) cancelAnimationFrame(animationFrameId); });
        budgetSlider.addEventListener('touchstart', () => { isSliding = true; if (animationFrameId) cancelAnimationFrame(animationFrameId); });
        budgetSlider.addEventListener('mouseup', handleSliderRelease);
        budgetSlider.addEventListener('touchend', handleSliderRelease);
        if(e85Toggle) e85Toggle.addEventListener('change', renderResults);
        renderResults();
    }

    function submitInquiry() {
        const firstNameInputContact = document.getElementById('customer-first-name');
        const lastNameInputContact = document.getElementById('customer-last-name');
        const emailInput = document.getElementById('customer-email'); 
        const phoneInput = document.getElementById('customer-phone');
        let isValid = true;
        [firstNameInputContact, lastNameInputContact, emailInput, phoneInput].forEach(input => {
            let fieldIsValid = !(!input.value || (input.type === 'email' && !/^\S+@\S+\.\S+$/.test(input.value)));
            if (!fieldIsValid) { isValid = false; input.style.borderColor = 'var(--color-primary)'; } else { input.style.borderColor = ''; }
        });
        if (!isValid) { setTimeout(() => { [firstNameInputContact, lastNameInputContact, emailInput, phoneInput].forEach(input => input.style.borderColor = ''); }, 2000); return; }
        saveStateToFirebase();
        const data = { firstName: document.getElementById('customer-first-name').value, lastName: document.getElementById('customer-last-name').value, email: document.getElementById('customer-email').value, phone: document.getElementById('customer-phone').value, year: yearSelect.value, make: makeSelect.value, model: modelSelect.value, trim: trimSelect.value, vin: userVin || 'N/A', selected_items: selectedItems.map(item => item.adjustedTitle || item.title).join(', ') };
        try { 
            const zapierWebhookUrl = "https://hooks.zapier.com/hooks/catch/19421224/ud0zpfj/"; 
            console.log("Sending data to Zapier:", data); 
            fetch(zapierWebhookUrl, { method: 'POST', body: JSON.stringify(data), mode: 'no-cors', headers: { 'Content-Type': 'application/json' } }); 
        } catch (err) { 
            console.error("Error sending to Zapier:", err); 
        }
        if (typeof fbq === "function") fbq('track', 'Purchase', {currency: "USD", value: selectedItems[0]?.price || 0.0});
        
        showThankYouPage();
    }

    // --- THANK YOU PAGE LOGIC ---
    async function runThankYouAnimation() {
        const thankYouAnimated = document.getElementById('thank-you-container-animated');
        const userName = userFirstName;
        const userCar = { model: `${makeSelect.value} ${modelSelect.value}`, engine: `${makeSelect.value} Engine` };
        
        const subtitleContainer = thankYouAnimated.querySelector('#thank-you-subtitle .animated-text-container');
        const iconContainer = thankYouAnimated.querySelector('#icon-container');
        const countdownBar = thankYouAnimated.querySelector('#countdown-bar');
        const prepAsset = thankYouAnimated.querySelector('.prep-asset');
        const progressBarContainer = thankYouAnimated.querySelector('.progress-bar-container');
        const prepAssetIconContainer = thankYouAnimated.querySelector('#prep-asset-icon-container');
        const prepAsseTitleText = thankYouAnimated.querySelector('#prep-asset-title-text');
        const expertImageCard = thankYouAnimated.querySelector('.expert-image-card');

        const mainIconAttributes = `trigger="loop" height="200" width="200" attributes='{"variationThumbColour":"#FF3B30","variationName":"Dark","variationNumber":4,"numberOfGroups":2,"strokeWidth":1.5,"backgroundIsGroup":true,"defaultColours":{"group-1":"#FF3B30","group-2":"#EAEAEA","background":"#141414"}}'`;
        const prepIconAttributes = `trigger="loop" height="24" width="24" attributes='{"variationThumbColour":"#FF3B30","variationName":"Dark","variationNumber":4,"numberOfGroups":2,"strokeWidth":2,"backgroundIsGroup":true,"defaultColours":{"group-1":"#FF3B30","group-2":"#EAEAEA","background":"#141414"}}'`;
        
        const iconMap = {
            0: `<animated-icons src="https://animatedicons.co/get-icon?name=High%20Five&style=minimalistic&token=dfda27f9-e133-49e0-bf9e-4d952d0ab596" ${mainIconAttributes}></animated-icons>`,
            1: `<animated-icons src="https://animatedicons.co/get-icon?name=Chatbot&style=minimalistic&token=30b1ab73-8407-40c6-ac85-74f21c602043" ${mainIconAttributes}></animated-icons>`,
            2: `<animated-icons src="https://animatedicons.co/get-icon?name=Maintenance&style=minimalistic&token=c427791f-d7f8-4a99-a56b-60ef3373e1f7" ${mainIconAttributes}></animated-icons>`,
            3: `<animated-icons src="https://animatedicons.co/get-icon?name=Research&style=minimalistic&token=debf6854-a861-4155-b483-b1a147f1f3ec" ${mainIconAttributes}></animated-icons>`,
            4: `<animated-icons src="https://animatedicons.co/get-icon?name=Advantage&style=minimalistic&token=bbc79435-552e-4da3-894d-89c634dc884b" ${mainIconAttributes}></animated-icons>`,
            5: `<animated-icons src="https://animatedicons.co/get-icon?name=Typing&style=minimalistic&token=1fe0b20b-e47a-4784-8e51-f4e99eaeec73" ${mainIconAttributes}></animated-icons>`,
            6: `<animated-icons src="https://animatedicons.co/get-icon?name=Dynamic%20Role&style=minimalistic&token=deb3f3dc-7e65-4d2a-a47e-e6447f4bab30" ${mainIconAttributes}></animated-icons>`,
            7: `<animated-icons src="https://animatedicons.co/get-icon?name=Competitiveness&style=minimalistic&token=74e4f843-59ad-4503-b28d-8656a63d73bd" ${mainIconAttributes}></animated-icons>`,
            8: `<animated-icons src="https://animatedicons.co/get-icon?name=KM&style=minimalistic&token=5729fdff-2cfc-4b8b-9952-2ff7da52563d" ${mainIconAttributes}></animated-icons>`,
            9: `<animated-icons src="https://animatedicons.co/get-icon?name=Warranty&style=minimalistic&token=240003ce-c76a-49ff-b69a-4123c54f8934" ${mainIconAttributes}></animated-icons>`,
            10: `<animated-icons src="https://animatedicons.co/get-icon?name=Neck%20Tie&style=minimalistic&token=762fea02-68a8-43f8-9153-42da75726e8c" ${mainIconAttributes}></animated-icons>`,
            'sunglasses': `<animated-icons src="https://animatedicons.co/get-icon?name=Sunglasses&style=minimalistic&token=d9992703-60aa-4186-87d3-fd225ebd1a12" ${mainIconAttributes}></animated-icons>`,
            'running': `<animated-icons src="https://animatedicons.co/get-icon?name=Running%20Person&style=minimalistic&token=f6cc1292-1aa7-4566-89b2-c5bfa23de4b6" ${mainIconAttributes}></animated-icons>`,
            11: `<animated-icons src="https://animatedicons.co/get-icon?name=Calling%20V3&style=minimalistic&token=66ff3706-138c-41fa-a993-dee03566e48c" ${mainIconAttributes}></animated-icons>`
        };
        const prepAssetIcons = {
            'identifying': `<animated-icons src="https://animatedicons.co/get-icon?name=Sensor&style=minimalistic&token=d2e63307-9111-4ea1-a108-0fd228efa70c" ${prepIconAttributes}></animated-icons>`,
            'assigning': `<animated-icons src="https://animatedicons.co/get-icon?name=Affiliate&style=minimalistic&token=563d6772-d486-4846-bcc5-92e4daad5f08" ${prepIconAttributes}></animated-icons>`,
            'confirmed': `<i class="fas fa-check-circle"></i>`
        };
        const storyTimeline = [
             { text: `Okay, ${userName}! Your blueprint for the ${userCar.model} is locked in.`, duration: 8000 },
             { text: `Our system is analyzing your goals for maximum power and style...`, duration: 8000 },
             { text: `Josh is earmarking the perfect bolt-ons for your build...`, duration: 10000 },
             { text: `Adam is reviewing fabrication needs for a flawless fit...`, duration: 10000 },
             { text: `Running advanced simulations... your performance is going to be unreal.`, duration: 12000 },
             { text: `Nick is already sketching out a custom tune for that ${userCar.engine}...`, duration: 10000 },
             { text: `This build has our entire shop buzzing with excitement, ${userName}.`, duration: 7000 },
             { text: `We're compiling a few exclusive options just for your build...`, duration: 10000 },
             { text: `The potential for your ${userCar.model} is off the charts.`, duration: 7000 },
             { text: `Your performance roadmap is being finalized right now...`, duration: 10000 },
             { text: `Thomas is getting ready for the call. He's excited to talk to you.`, duration: 18000 },
             { text: `The wait is over! Your performance expert is calling now!`, duration: 10000 }
        ];
        const totalDuration = storyTimeline.reduce((acc, s) => acc + s.duration, 0);
        const typeWriter = (element, text, i = 0) => new Promise(resolve => {
            const speed = 50;
            if (i < text.length) {
                element.innerHTML = text.substring(0, i + 1) + '<span class="cursor"></span>';
                setTimeout(() => resolve(typeWriter(element, text, i + 1)), speed);
            } else {
                element.innerHTML = text;
                resolve();
            }
        });
        const eraseWriter = (element, text, i = text.length -1) => new Promise(resolve => {
            const speed = 30;
            if (i >= 0) {
                element.innerHTML = text.substring(0, i) + '<span class="cursor"></span>';
                setTimeout(() => resolve(eraseWriter(element, text, i - 1)), speed);
            } else {
                 element.innerHTML = '';
                 resolve();
            }
        });
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        const firstStep = storyTimeline[0];
        const firstTypeDuration = firstStep.text.length * 50;
        const firstEraseDuration = firstStep.text.length * 30;
        let masterStartTime = Date.now();
        let animationFrameId;
        const panel = document.querySelector('.panel-thank-you');
        const animateBar = () => {
            const elapsedTime = Date.now() - masterStartTime;
            let progress = elapsedTime / totalDuration;
            if (progress > 1) progress = 1;
            if (!progressBarContainer.classList.contains('expanded')) {
                const bootUpProgress = elapsedTime / firstStep.duration;
                countdownBar.style.width = `${bootUpProgress * 100}%`;
            } else {
                countdownBar.style.width = `${progress * 100}%`;
            }
            const maxDim = 0.4;
            panel.style.setProperty('--overlay-opacity', progress * maxDim);
            const colorChangeStart = 0.1;
            const colorChangeEnd = 0.25; 
            const startColor = { r: 255, g: 255, b: 255 };
            const endColor = { r: 255, g: 59, b: 48 };
            let r = startColor.r, g = startColor.g, b = startColor.b;
            if (progress >= colorChangeStart && progress <= colorChangeEnd) {
                const colorProgress = (progress - colorChangeStart) / (colorChangeEnd - colorChangeStart);
                g = Math.round(startColor.g - (startColor.g - endColor.g) * colorProgress);
                b = Math.round(startColor.b - (startColor.b - endColor.b) * colorProgress);
            } else if (progress > colorChangeEnd) {
               g = endColor.g;
               b = endColor.b;
            }
            countdownBar.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
            const gradientRgbaColor = `rgba(${r}, ${g}, ${b}, 0.4)`;
            expertImageCard.style.setProperty('--gradient-glow-color', gradientRgbaColor);
            const glowStart = 0.25;
            const glowEnd = 0.5;
            const maxGlowOpacity = 0.9;
            const maxIconGlowOpacity = 0.45;
            if (progress > glowStart) {
                let glowProgress = (progress - glowStart) / (glowEnd - glowStart);
                if (glowProgress > 1) glowProgress = 1;
                const currentBarGlowOpacity = glowProgress * maxGlowOpacity;
                const currentIconGlowOpacity = glowProgress * maxIconGlowOpacity;
                countdownBar.style.setProperty('--glow-opacity', currentBarGlowOpacity);
                iconContainer.style.setProperty('--icon-glow-opacity', currentIconGlowOpacity);
            } else {
                countdownBar.style.setProperty('--glow-opacity', 0);
                iconContainer.style.setProperty('--icon-glow-opacity', 0);
            }
            animationFrameId = requestAnimationFrame(animateBar);
        };
        iconContainer.innerHTML = `<div class="icon-wrapper icon-in">${iconMap[0]}</div>`;
        requestAnimationFrame(animateBar);
        const typePromise = typeWriter(subtitleContainer, firstStep.text);
        setTimeout(async () => {
            prepAsset.classList.add('is-visible');
            prepAsseTitleText.textContent = "Identifying optimal agent...";
            prepAssetIconContainer.innerHTML = prepAssetIcons.identifying;
            await sleep(1500);
            prepAsseTitleText.textContent = "Assigning Expert to Case...";
            prepAssetIconContainer.innerHTML = prepAssetIcons.assigning;
        }, firstTypeDuration / 2);
        await typePromise;
        await sleep(storyTimeline[0].duration - firstTypeDuration - firstEraseDuration);
        setTimeout(() => {
            progressBarContainer.classList.add('expanded');
            prepAsset.classList.add('full-reveal');
            prepAsseTitleText.textContent = "Your Consultation is Moments Away";
            prepAssetIconContainer.innerHTML = prepAssetIcons.confirmed;
        }, firstEraseDuration / 2);
        await eraseWriter(subtitleContainer, firstStep.text);
        await sleep(800);
        for (let i = 1; i < storyTimeline.length; i++) {
            const step = storyTimeline[i];
            if (i === 10) {
                const text = step.text;
                const subDuration = step.duration / 3;
                let currentIcon = iconContainer.querySelector('.icon-wrapper');
                if(currentIcon) { currentIcon.classList.add('icon-out'); await sleep(400); }
                iconContainer.innerHTML = `<div class="icon-wrapper icon-in">${iconMap[10]}</div>`;
                const typePromise = typeWriter(subtitleContainer, text);
                await sleep(subDuration - 400);
                currentIcon = iconContainer.querySelector('.icon-wrapper');
                if(currentIcon) { currentIcon.classList.add('icon-out'); await sleep(400); }
                iconContainer.innerHTML = `<div class="icon-wrapper icon-in">${iconMap['sunglasses']}</div>`;
                await sleep(subDuration - 400);
                currentIcon = iconContainer.querySelector('.icon-wrapper');
                if(currentIcon) { currentIcon.classList.add('icon-out'); await sleep(400); }
                iconContainer.innerHTML = `<div class="icon-wrapper icon-in">${iconMap['running']}</div>`;
                await typePromise;
                await sleep(subDuration - 400);
                await eraseWriter(subtitleContainer, text);
            } else {
                const currentIcon = iconContainer.querySelector('.icon-wrapper');
                if (currentIcon) {
                    currentIcon.classList.add('icon-out');
                    await sleep(400);
                }
                iconContainer.innerHTML = `<div class="icon-wrapper icon-in">${iconMap[i]}</div>`;
                const typeDuration = step.text.length * 50;
                const eraseDuration = step.text.length * 30;
                let pauseDuration = step.duration - typeDuration - eraseDuration - 1000;
                if (pauseDuration < 1000) pauseDuration = 1000;
                await typeWriter(subtitleContainer, step.text);
                await sleep(pauseDuration);
                if (i < storyTimeline.length - 1) {
                     await eraseWriter(subtitleContainer, step.text);
                }
            }
        }
        cancelAnimationFrame(animationFrameId);
    }

    function showThankYouPage() {
        questionnaireContainer.classList.remove('active');
        questionnaireContainer.classList.add('hidden-field');
        validateAndStoreName();
        window.scrollTo(0, 0);

        const now = new Date();
        const day = now.getDay(); // Sunday = 0, Monday = 1, etc.
        const hour = now.getHours();
        // Business hours: Mon-Fri (1-5), 9am to 5pm (hour 17 is 5pm)
        const isBusinessHours = day >= 1 && day <= 5 && hour >= 9 && hour < 17;

        if (isBusinessHours) {
            const thankYouAnimated = document.getElementById('thank-you-container-animated');
            thankYouAnimated.classList.remove('hidden-field');
            thankYouAnimated.classList.add('active');
            runThankYouAnimation();
        } else {
            // It's outside business hours. Show the static page.
            const thankYouStatic = document.getElementById('thank-you-container-static');
            thankYouStatic.classList.remove('hidden-field');
            thankYouStatic.classList.add('active');
        }
    }
    
    // --- APP INITIALIZATION ---
    async function runApp() {
        try {
            if (typeof firebase !== 'undefined' && typeof __firebase_config !== 'undefined') {
                firebase.initializeApp(JSON.parse(__firebase_config)); db = firebase.firestore(); auth = firebase.auth();
                const user = (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) ? await auth.signInWithCustomToken(__initial_auth_token) : await auth.signInAnonymously();
                isFirebaseReady = true; console.log("Firebase Connected. UID:", user.user.uid);
                sessionId = getCookie('configuratorSessionId') || generateUUID(); setCookie('configuratorSessionId', sessionId, 30);
            } else { throw new Error("Firebase not available."); }
        } catch (e) { console.warn("Running in offline mode.", e.message); }

        try {
            const response = await fetch('https://cdn.shopify.com/s/files/1/0671/4635/0805/files/WIKD-Motorsports-Data.json?v=1755118954');
            if (!response.ok) throw new Error('Network response failed');
            const data = await response.json();
            packages = data.packages;
            await loadCarMakes();
            populateYears();
            checkBusinessHours();
            questionnaireContainer.classList.add('active');
            initializeProgressBar();
            if (isFirebaseReady && sessionId) await loadStateFromFirebase(sessionId);

            // Centralized event listener for dynamic content
            questionnaireContainer.addEventListener('click', function(e) {
                const target = e.target;
                const prevBtn = target.closest('.prev-btn');
                const submitBtn = target.closest('.submit-inquiry-btn');
                const collapsibleHeader = target.closest('.collapsible-header');
                const partsToggle = target.closest('.parts-toggle-btn');

                if (prevBtn) {
                    updateStep(1);
                }
                if (submitBtn) {
                    submitInquiry();
                }
                if (collapsibleHeader) {
                    const content = collapsibleHeader.nextElementSibling;
                    const icon = collapsibleHeader.querySelector('i');
                    if (content) content.classList.toggle('active');
                    if (icon) icon.classList.toggle('rotate-180');
                }
                if (partsToggle) {
                    const content = partsToggle.nextElementSibling;
                    const icon = partsToggle.querySelector('i');
                    if (content) content.classList.toggle('active');
                    if (icon) icon.classList.toggle('rotate-180');
                }
            });

            // QR Code Tooltip Logic
            callLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    if (!isMobileDevice()) {
                        e.preventDefault();
                        e.stopPropagation();
                        const tooltip = this.parentElement.querySelector('.qr-tooltip');
                        if (!tooltip) return;
                        const canvas = tooltip.querySelector('.qr-code-canvas');
                        const isActive = tooltip.classList.contains('active');
                        
                        document.querySelectorAll('.qr-tooltip.active').forEach(activeTooltip => {
                            if (activeTooltip !== tooltip) {
                                activeTooltip.classList.remove('active');
                            }
                        });

                        if (!isActive) {
                            tooltip.classList.add('active');
                            if (!canvas.dataset.rendered) {
                                QRCode.toCanvas(canvas, `tel:${phoneNumber.replace(/\D/g, '')}`, {
                                    width: 150,
                                    margin: 1,
                                    color: {
                                        dark: '#FF3B30',
                                        light: '#141414'
                                    }
                                }, function (error) {
                                    if (error) console.error(error);
                                    canvas.dataset.rendered = 'true';
                                });
                            }
                        } else {
                            tooltip.classList.remove('active');
                        }
                    }
                });
            });

            document.addEventListener('click', function(e) {
                if (!e.target.closest('.call-link-container')) {
                    document.querySelectorAll('.qr-tooltip.active').forEach(tooltip => {
                        tooltip.classList.remove('active');
                    });
                }
            });


            const panels = document.querySelectorAll('#questionnaire-container .panel'); const themes = ['theme-exhaust', 'theme-packages', 'theme-wheels', 'theme-cooling']; let currentThemeIndex = 0, isBeforePrimary = true;
            panels.forEach(p => { p.classList.add(themes[0] + '-before', 'show-before'); });
            setInterval(() => { const nextThemeIndex = (currentThemeIndex + 1) % themes.length; const newTheme = themes[nextThemeIndex]; panels.forEach(p => { if (isBeforePrimary) { themes.forEach(t => p.classList.remove(t + '-after')); p.classList.add(newTheme + '-after', 'show-after'); p.classList.remove('show-before'); } else { themes.forEach(t => p.classList.remove(t + '-before')); p.classList.add(newTheme + '-before', 'show-before'); p.classList.remove('show-after'); } }); currentThemeIndex = nextThemeIndex; isBeforePrimary = !isBeforePrimary; }, 7000);
        } catch (error) {
            console.error('Failed to initialize app core:', error);
            document.querySelector('#step-1 .panel').innerHTML = `<div class="step-header"><h2 style="color: var(--color-primary);">Error Loading Data</h2><p>Could not load configurator data. Please refresh or contact support.</p></div>`;
        }
    }
    
    function initializeProgressBar() { const totalSteps = progressSteps.length; const barStartOffset = (1 / totalSteps / 2) * 100; progressBar.style.setProperty('--bar-start-offset', `${barStartOffset}%`); progressBar.style.setProperty('--bar-width', `${100 - (barStartOffset * 2)}%`); updateStep(1, true); }
    function checkBusinessHours() { /* ... unchanged ... */ }
    runApp();
});
</script>
</body>
</html>


